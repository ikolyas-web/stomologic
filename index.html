<!doctype html>
<html lang="ru">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StomoLogic - –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
:root {
--bg-primary: #0a0a0a;
--bg-secondary: #1a1a1a;
--accent: #00d4aa;
--text-primary: #ffffff;
--text-secondary: #b0b0b0;
--border: #333;
--input-bg: #2a2a2a;
--danger: #ef4444;
--success: #10b981;
}
[data-theme="light"] {
--bg-primary: #f8fafc;
--bg-secondary: #ffffff;
--accent: #059669;
--text-primary: #1e293b;
--text-secondary: #64748b;
--border: #e2e8f0;
--input-bg: #f1f5f9;
--danger: #dc2626;
--success: #059669;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: var(--bg-primary);
color: var(--text-primary);
padding: 20px;
min-height: 100vh;
}
.container { max-width: 1400px; margin: 0 auto; }

.header-kpi {
background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
border-radius: 20px;
padding: 30px;
margin-bottom: 30px;
border: 1px solid var(--border);
box-shadow: 0 20px 40px rgba(0,0,0,0.3);
text-align: center;
}
.kpi-title {
font-size: 2.2rem;
background: linear-gradient(135deg, var(--accent), #14b8a6);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
margin-bottom: 25px;
}
.kpi-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
gap: 20px;
}
.kpi-item {
padding: 20px;
background: rgba(0,212,170,0.15);
border-radius: 12px;
border: 1px solid rgba(0,212,170,0.3);
}
.kpi-value { font-size: 1.8rem; font-weight: 700; color: var(--accent); margin-bottom: 5px; }
.kpi-label { color: var(--text-secondary); font-size: 0.85rem; }

.theme-toggle {
position: fixed; top: 20px; right: 20px;
background: var(--bg-secondary); border: 1px solid var(--border);
color: var(--text-primary); padding: 12px; border-radius: 50px;
cursor: pointer; z-index: 1000;
}

.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px; }
@media (max-width: 1200px) { .grid { grid-template-columns: 1fr 1fr; } }
@media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

.card {
background: var(--bg-secondary);
border-radius: 16px;
padding: 24px;
border: 1px solid var(--border);
box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.card h3 { margin-bottom: 20px; color: var(--accent); font-size: 1.3rem; }

.input-group {
margin-bottom: 16px;
display: flex; align-items: center; gap: 12px;
}
.input-group label { min-width: 200px; font-weight: 500; color: var(--text-secondary); }
.input-group-controls {
display: flex; gap: 12px; align-items: center; flex: 1;
}
input[type="range"] {
flex: 1; height: 6px; border-radius: 3px;
}
input[type="number"],
input[type="text"] {
padding: 10px 12px; border: 1px solid var(--border);
background: var(--input-bg); color: var(--text-primary);
border-radius: 8px; font-size: 0.9rem;
width: 110px;
}
input {
padding: 12px 16px; border: 1px solid var(--border);
background: var(--input-bg); color: var(--text-primary);
border-radius: 8px; font-size: 1rem;
}
input:focus {
outline: none; border-color: var(--accent);
box-shadow: 0 0 0 3px rgba(0,212,170,0.1);
}
.credit-group {
background: rgba(239,68,68,0.1);
border: 2px solid var(--danger);
border-radius: 12px;
padding: 16px;
margin: 12px 0;
}
.btn {
background: var(--accent);
color: #000;
border: none;
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
margin-right: 8px;
margin-bottom: 8px;
}
.btn:hover { opacity: 0.9; }
.btn-danger {
background: var(--danger);
color: white;
}
.btn-danger:hover { opacity: 0.9; }
.btn-secondary {
background: var(--text-secondary);
color: #000;
}

.invest-summary {
margin-top: 20px; padding: 16px;
background: rgba(0,212,170,0.1);
border-radius: 8px;
}
.invest-row {
display: flex; justify-content: space-between;
margin-bottom: 8px; font-size: 0.95rem;
}
.invest-value { font-weight: 600; color: var(--accent); }

.investors-table-wrapper {
overflow-x: auto;
margin-top: 16px;
}
.investors-table {
width: 100%;
border-collapse: collapse;
font-size: 0.9rem;
}
.investors-table th {
background: rgba(0,212,170,0.2);
color: var(--accent);
padding: 12px;
text-align: left;
border-bottom: 2px solid var(--accent);
font-weight: 600;
}
.investors-table td {
padding: 12px;
border-bottom: 1px solid var(--border);
}
.investors-table tr:hover {
background: rgba(0,212,170,0.05);
}
.investor-name-input {
background: var(--input-bg);
border: 1px solid var(--border);
color: var(--text-primary);
padding: 6px 8px;
border-radius: 4px;
font-size: 0.9rem;
width: 120px;
}
.investor-share-input {
background: var(--input-bg);
border: 1px solid var(--border);
color: var(--text-primary);
padding: 6px 8px;
border-radius: 4px;
font-size: 0.9rem;
width: 70px;
}
.investor-value {
color: var(--success);
font-weight: 600;
}
.investor-empty {
color: var(--text-secondary);
text-align: center;
padding: 24px !important;
}

.charts-grid {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 20px;
height: 400px;
margin-bottom: 30px;
}
@media (max-width: 1400px) { .charts-grid { grid-template-columns: 1fr; } }
@media (max-width: 768px) { .charts-grid { height: 300px; } }
canvas { width: 100% !important; height: 100% !important; }

/* –°—Ü–µ–Ω–∞—Ä–∏–∏ */
.scenarios-panel {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
margin-bottom: 30px;
}
@media (max-width: 768px) { .scenarios-panel { grid-template-columns: 1fr; } }

.scenario-control {
background: var(--bg-secondary);
border-radius: 16px;
padding: 20px;
border: 1px solid var(--border);
}
.scenario-control h3 { margin-bottom: 15px; color: var(--accent); font-size: 1.1rem; }

.scenario-input {
display: flex; gap: 10px; margin-bottom: 15px;
}
.scenario-input input {
flex: 1;
padding: 10px 12px;
border: 1px solid var(--border);
background: var(--input-bg);
color: var(--text-primary);
border-radius: 8px;
font-size: 0.9rem;
}

.scenarios-table {
width: 100%;
border-collapse: collapse;
font-size: 0.85rem;
margin-top: 15px;
}
.scenarios-table th {
background: rgba(0,212,170,0.2);
color: var(--accent);
padding: 10px;
text-align: left;
border-bottom: 2px solid var(--accent);
font-weight: 600;
}
.scenarios-table td {
padding: 10px;
border-bottom: 1px solid var(--border);
}
.scenarios-table tr:hover {
background: rgba(0,212,170,0.05);
cursor: pointer;
}
.scenario-badge {
display: inline-block;
padding: 4px 12px;
border-radius: 20px;
font-size: 0.75rem;
font-weight: 600;
}
.scenario-badge-base {
background: rgba(54, 162, 235, 0.3);
color: #36A2EB;
}
.scenario-badge-current {
background: rgba(0, 212, 170, 0.3);
color: var(--accent);
}
.scenario-badge-compare {
background: rgba(255, 193, 7, 0.3);
color: #FFC107;
}

.comparison-modal {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.7);
display: none;
align-items: center;
justify-content: center;
z-index: 2000;
}
.comparison-modal.active { display: flex; }
.comparison-modal-content {
background: var(--bg-secondary);
border-radius: 16px;
padding: 30px;
max-width: 90%;
max-height: 90%;
overflow-y: auto;
border: 1px solid var(--border);
width: 100%;
max-width: 900px;
}
.comparison-modal-close {
float: right;
cursor: pointer;
font-size: 28px;
color: var(--accent);
margin: -10px -10px 20px 0;
}
.comparison-table {
width: 100%;
border-collapse: collapse;
font-size: 0.9rem;
margin-top: 20px;
}
.comparison-table th {
background: rgba(0,212,170,0.2);
color: var(--accent);
padding: 12px;
text-align: left;
border-bottom: 2px solid var(--accent);
font-weight: 600;
}
.comparison-table td {
padding: 12px;
border-bottom: 1px solid var(--border);
}
.comparison-better {
background: rgba(16, 185, 129, 0.1);
color: #10b981;
font-weight: 600;
}
.comparison-worse {
background: rgba(239, 68, 68, 0.1);
color: #ef4444;
}
</style>
  <style>body { box-sizing: border-box; }</style>
  <script src="https://cdn.tailwindcss.com/3.4.17" type="text/javascript"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
  <div class="container">
   <div class="header-kpi">
    <div class="kpi-title">
     StomoLogic
    </div>
    <div class="kpi-grid" id="headerKpis"></div>
   </div><!-- –°—Ü–µ–Ω–∞—Ä–∏–∏ -->
   <div class="scenarios-panel">
    <div class="scenario-control">
     <h3>üìç –¢–æ—á–∫–∞ –ê (–ë–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)</h3>
     <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–∫ –±–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p><button class="btn" onclick="fixPointA()">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É –ê</button>
     <div style="margin-top: 15px; padding: 12px; background: rgba(0,212,170,0.1); border-radius: 8px; border: 1px solid rgba(0,212,170,0.3); display: none;" id="pointADisplay">
      <div style="font-size: 0.9rem; color: var(--text-secondary);">
       –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ:
      </div>
      <div style="font-weight: 600; color: var(--accent); margin-top: 8px;" id="pointATime">
       -
      </div>
     </div>
    </div>
    <div class="scenario-control">
     <h3>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</h3>
     <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">–î–∞–π—Ç–µ –∏–º—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</p>
     <div class="scenario-input">
      <input type="text" id="scenarioName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è (e.g. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π)"> <button class="btn" onclick="saveScenario()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
     </div>
    </div>
   </div>
   <div class="card" style="grid-column: 1 / -1; margin-bottom: 30px;">
    <h3>üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏</h3>
    <div class="investors-table-wrapper">
     <table class="scenarios-table">
      <thead>
       <tr>
        <th style="width: 200px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th style="width: 150px;">–í—ã—Ä—É—á–∫–∞/–º–µ—Å</th>
        <th style="width: 150px;">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å/–º–µ—Å</th>
        <th style="width: 150px;">ROI</th>
        <th style="width: 180px;">–î–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</th>
        <th style="width: 200px;">–î–µ–π—Å—Ç–≤–∏—è</th>
       </tr>
      </thead>
      <tbody id="scenariosTableBody">
       <tr>
        <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 24px;">–°—Ü–µ–Ω–∞—Ä–∏–µ–≤ –µ—â–µ –Ω–µ—Ç. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π!</td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
   <div class="grid">
    <!-- –í—ã—Ä—É—á–∫–∞ -->
    <div class="card">
     <h3>üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã—Ä—É—á–∫–∏</h3>
     <div class="input-group">
      <label>–†–∞–±–æ—á–∏–µ –¥–Ω–∏/–º–µ—Å:</label>
      <div class="input-group-controls">
       <input type="range" id="workDays" min="20" max="30" value="21"> <input type="number" id="workDaysInput" min="20" max="30" value="21">
      </div>
     </div>
     <div class="input-group">
      <label>–ö—Ä–µ—Å–ª–∞:</label>
      <div class="input-group-controls">
       <input type="range" id="chairs" min="1" max="20" value="5"> <input type="number" id="chairsInput" min="1" max="20" value="5">
      </div>
     </div>
     <div class="input-group">
      <label>–ß–∞—Å—ã/–∫—Ä–µ—Å–ª–æ:</label>
      <div class="input-group-controls">
       <input type="range" id="hours" min="8" max="12" value="12"> <input type="number" id="hoursInput" min="8" max="12" value="12">
      </div>
     </div>
     <div class="input-group">
      <label>–ó–∞–≥—Ä—É–∑–∫–∞ %:</label>
      <div class="input-group-controls">
       <input type="range" id="load" min="0" max="85" value="0"> <input type="number" id="loadInput" min="0" max="85" value="0">
      </div>
     </div>
     <div class="input-group">
      <label>–ù–æ—Ä–º–æ-—á–∞—Å ‚ÇΩ:</label>
      <div class="input-group-controls">
       <input type="range" id="normoHour" min="8000" max="100000" value="18000"> <input type="number" id="normoHourInput" min="8000" max="100000" value="18000">
      </div>
     </div>
    </div><!-- –†–∞—Å—Ö–æ–¥—ã -->
    <div class="card">
     <h3>üí∞ –†–∞—Å—Ö–æ–¥—ã (% –≤—ã—Ä—É—á–∫–∏)</h3>
     <div class="input-group">
      <label>–°/–° %:</label>
      <div class="input-group-controls">
       <input type="range" id="soc" min="6" max="20" value="8"> <input type="number" id="socInput" min="6" max="20" value="8">
      </div>
     </div>
     <div class="input-group">
      <label>–§–û–¢ –≤—Ä–∞—á–µ–π %:</label>
      <div class="input-group-controls">
       <input type="range" id="fotDoctors" min="0" max="50" value="0"> <input type="number" id="fotDoctorsInput" min="0" max="50" value="0">
      </div>
     </div>
     <div class="input-group">
      <label>–§–û–¢ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ %:</label>
      <div class="input-group-controls">
       <input type="range" id="fotStaff" min="0" max="50" value="0"> <input type="number" id="fotStaffInput" min="0" max="50" value="0">
      </div>
     </div>
     <div class="input-group">
      <label>–ó–¢–õ %:</label>
      <div class="input-group-controls">
       <input type="range" id="ztl" min="0" max="40" value="0"> <input type="number" id="ztlInput" min="0" max="40" value="0">
      </div>
     </div>
     <div class="input-group">
      <label>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–ª–∏–Ω–∏–∫–∏ %:</label>
      <div class="input-group-controls">
       <input type="range" id="clinic" min="1" max="50" value="17"> <input type="number" id="clinicInput" min="1" max="50" value="17">
      </div>
     </div>
     <div class="input-group">
      <label>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ %:</label>
      <div class="input-group-controls">
       <input type="range" id="marketing" min="1" max="15" value="5"> <input type="number" id="marketingInput" min="1" max="15" value="5">
      </div>
     </div>
     <div class="input-group">
      <label>–ê—Ä–µ–Ω–¥–∞ ‚ÇΩ:</label>
      <div class="input-group-controls">
       <input type="range" id="rent" min="60000" max="3000000" value="2700000"> <input type="number" id="rentInput" min="60000" max="3000000" value="2700000">
      </div>
     </div>
     <div class="input-group">
      <label>–ù–∞–ª–æ–≥ %:</label>
      <div class="input-group-controls">
       <input type="range" id="tax" min="0" max="30" value="0"> <input type="number" id="taxInput" min="0" max="30" value="0">
      </div>
     </div>
    </div><!-- –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ + –ö–†–ï–î–ò–¢ -->
    <div class="card">
     <h3>üíé –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ &amp; –ö—Ä–µ–¥–∏—Ç</h3>
     <div class="input-group">
      <label>–í–ª–æ–∂–µ–Ω–∏—è ‚ÇΩ:</label>
      <div class="input-group-controls">
       <input type="range" id="capex" min="0" max="200000000" value="0"> <input type="number" id="capexInput" min="0" max="200000000" value="0">
      </div>
     </div>
     <div class="credit-group">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
       <label>üí≥ –ö—Ä–µ–¥–∏—Ç 54M</label> <span style="color: var(--danger); font-weight: 700;" id="creditPaymentDisplay">–ü–ª–∞—Ç–µ–∂: 1.7M ‚ÇΩ/–º–µ—Å</span>
      </div>
      <div style="display: flex; gap: 12px; align-items: center;">
       <input type="checkbox" id="payoffDebt"> <label for="payoffDebt" style="flex: 1; margin: 0;">–ü–æ–≥–∞—Å–∏—Ç—å –ø—Ä–∏ –≤–ª–æ–∂–µ–Ω–∏—è—Ö &gt; 54M</label>
      </div>
     </div>
     <div class="input-group">
      <label>–°—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä., %:</label>
      <div class="input-group-controls">
       <input type="range" id="discountRate" min="8" max="20" value="12"> <input type="number" id="discountRateInput" min="8" max="20" value="12">
      </div>
     </div>
     <div class="invest-summary">
      <div class="invest-row">
       <span>–û–±—â–∏–µ –≤–ª–æ–∂–µ–Ω–∏—è:</span> <span class="invest-value" id="totalInvest">0 ‚ÇΩ</span>
      </div>
      <div class="invest-row">
       <span>–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å:</span> <span class="invest-value" id="paybackDisplay">-</span>
      </div>
      <div class="invest-row">
       <span>ROI –≥–æ–¥–æ–≤—ã—Ö:</span> <span class="invest-value" id="roiDisplay">-</span>
      </div>
      <div class="invest-row">
       <span>NPV (5 –ª–µ—Ç):</span> <span class="invest-value" id="npvDisplay">-</span>
      </div>
     </div>
    </div>
   </div><!-- –ò–ù–í–ï–°–¢–û–†–´ - –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ -->
   <div class="card" style="grid-column: 1 / -1;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 20px;">
     <h3 style="margin: 0;">üíº –ò–Ω–≤–µ—Å—Ç–æ—Ä—ã</h3>
     <div style="display: flex; gap: 30px; align-items: center; flex-wrap: wrap;">
      <div class="input-group" style="margin: 0;">
       <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
       <div class="input-group-controls">
        <input type="range" id="investorCount" min="0" max="10" value="0" style="width: 150px;"> <input type="number" id="investorCountInput" min="0" max="10" value="0" style="width: 60px;">
       </div>
      </div>
      <div class="input-group" style="margin: 0;">
       <label>–í—ã–ø–ª–∞—Ç–∞ –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ %:</label>
       <div class="input-group-controls">
        <input type="range" id="dividendRate" min="0" max="100" value="50" style="width: 150px;"> <input type="number" id="dividendRateInput" min="0" max="100" value="50" style="width: 60px;">
       </div>
      </div>
     </div>
    </div>
    <div class="investors-table-wrapper">
     <table class="investors-table">
      <thead>
       <tr>
        <th style="width: 150px;">–ò–Ω–≤–µ—Å—Ç–æ—Ä</th>
        <th style="width: 100px;">–î–æ–ª—è %</th>
        <th style="width: 120px;">–ü—Ä–æ–≥–Ω–æ–∑ –ì1</th>
        <th style="width: 120px;">–ü—Ä–æ–≥–Ω–æ–∑ –ì2</th>
        <th style="width: 120px;">–ü—Ä–æ–≥–Ω–æ–∑ –ì3</th>
        <th style="width: 140px;">–í—Å–µ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑</th>
       </tr>
      </thead>
      <tbody id="investorsTable">
       <tr>
        <td colspan="6" class="investor-empty">–î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ —Å –ø–æ–º–æ—â—å—é –ø–æ–ª–∑—É–Ω–∫–∞ –≤—ã—à–µ</td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
  </div>
  <div class="charts-grid">
   <div class="card">
    <h3>üìà Cash Flow (36 –º–µ—Å—è—Ü–µ–≤)</h3>
    <div style="height: 350px;">
     <canvas id="cashFlowChart"></canvas>
    </div>
   </div>
   <div class="card">
    <h3>üíµ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º</h3>
    <div style="height: 350px;">
     <canvas id="revenueVsProfitChart"></canvas>
    </div>
   </div>
   <div class="card">
    <h3>üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
    <div style="height: 350px;">
     <canvas id="expensesChart"></canvas>
    </div>
   </div>
   <div class="card">
    <h3>üåô –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å <small>(–ö—Ä–∞—Å–Ω—ã–π&lt;1, –ó–µ–ª–µ–Ω—ã–π‚â•1)</small></h3>
    <div style="height: 350px;">
     <canvas id="seasonalityChart"></canvas>
    </div>
   </div>
  </div><!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
  <div class="comparison-modal" id="comparisonModal">
   <div class="comparison-modal-content">
    <span class="comparison-modal-close" onclick="closeComparison()">√ó</span>
    <h2 style="color: var(--accent); margin-bottom: 20px;">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤</h2>
    <div id="comparisonContent"></div>
   </div>
  </div>
  <script>
let state = {
workDays: 21, chairs: 5, hours: 12, load: 0, normoHour: 18000,
soc: 8, fotDoctors: 0, fotStaff: 0, ztl: 0, clinic: 17,
rent: 2700000, marketing: 5, tax: 0, capex: 0,
discountRate: 12, payoffDebt: false,
investorCount: 0, dividendRate: 50,
investors: [],
netProfitMonthly: 0
};

let scenarios = [];
let pointA = null;
let currentMetrics = null;

const SEASONALITY = {
labels: ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'],
factors: [0.71, 1.01, 1.12, 1.03, 0.96, 1.08, 1.02, 0.99, 0.99, 0.98, 1.04, 1.06]
};

const CREDIT = {
debt: 54000000,
monthlyPayment: 1700000,
threshold: 54000000
};

let cashFlowChart, revenueVsProfitChart, expensesChart, seasonalityChart;

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏–∑ localStorage
function loadScenariosFromStorage() {
const stored = localStorage.getItem('stomo_scenarios');
if (stored) {
  try {
    scenarios = JSON.parse(stored);
    updateScenariosTable();
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤', e);
  }
}
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ localStorage
function saveScenariosToStorage() {
localStorage.setItem('stomo_scenarios', JSON.stringify(scenarios));
}

document.addEventListener('DOMContentLoaded', function() {
initCharts();
bindInputs();
loadScenariosFromStorage();
updateAll();
});

function bindInputs() {
const inputs = [
'workDays','chairs','hours','load','normoHour',
'soc','fotDoctors','fotStaff','ztl','clinic','rent','marketing','tax',
'capex','discountRate','investorCount','dividendRate'
];
inputs.forEach(id => {
const sliderEl = document.getElementById(id);
const inputEl = document.getElementById(id + 'Input');

if (sliderEl) {
sliderEl.addEventListener('input', function() {
state[id] = +sliderEl.value;
if (inputEl) inputEl.value = +sliderEl.value;
if (id === 'investorCount') {
  state.investors = Array(+sliderEl.value).fill().map((_,i) => state.investors[i] || {name: `–ò–Ω–≤–µ—Å—Ç–æ—Ä ${i+1}`, share: 100 / Math.max(1, +sliderEl.value)});
  normalizeInvestorShares();
}
updateAll();
});
}

if (inputEl) {
inputEl.addEventListener('change', function() {
let val = +inputEl.value;
const min = +sliderEl.getAttribute('min');
const max = +sliderEl.getAttribute('max');
val = Math.min(Math.max(val, min), max);
state[id] = val;
sliderEl.value = val;
inputEl.value = val;
if (id === 'investorCount') {
  state.investors = Array(+val).fill().map((_,i) => state.investors[i] || {name: `–ò–Ω–≤–µ—Å—Ç–æ—Ä ${i+1}`, share: 100 / Math.max(1, +val)});
  normalizeInvestorShares();
}
updateAll();
});

inputEl.addEventListener('input', function() {
sliderEl.value = +inputEl.value;
});
}
});

const checkbox = document.getElementById('payoffDebt');
if (checkbox) {
checkbox.addEventListener('change', function() {
state.payoffDebt = this.checked;
updateAll();
});
}
}

function normalizeInvestorShares() {
if (state.investors.length === 0) return;
const totalShare = state.investors.reduce((sum, inv) => sum + inv.share, 0);
if (Math.abs(totalShare - 100) > 0.1) {
  state.investors.forEach(inv => {
    inv.share = (inv.share / totalShare) * 100;
  });
}
}

function calculateMetrics() {
const capacity = state.workDays * state.chairs * state.hours;
const utilization = capacity * (state.load / 100);
const revenue = utilization * state.normoHour;
const revenueAnnual = revenue * 12;

const totalVarCosts = revenue * ((
state.soc + state.fotDoctors + state.fotStaff +
state.ztl + state.clinic + state.marketing
) / 100);

const opexMonthly = totalVarCosts + state.rent;
const ebitda = revenue - opexMonthly;
const profitBeforeTax = ebitda;
const profit = profitBeforeTax * (1 - state.tax / 100);
const profitAnnual = profit * 12;

const creditPayment = (state.payoffDebt && state.capex >= CREDIT.threshold) ? 0 : CREDIT.monthlyPayment;
const netProfitMonthly = profit - creditPayment;
const netProfitAnnual = netProfitMonthly * 12;
const rcpMargin = ebitda / revenue * 100 || 0;

const totalInvestment = state.capex;

state.netProfitMonthly = netProfitMonthly;

const dividendPoolMonthly = netProfitMonthly > 0 ? netProfitMonthly * (state.dividendRate / 100) : 0;

const investorYearlyDividends = state.investors.map((inv, i) => ({
  forecastYear1: netProfitMonthly > 0 ? calculateInvestorYearlyForecast(0, i) : 0,
  forecastYear2: netProfitMonthly > 0 ? calculateInvestorYearlyForecast(12, i) : 0,
  forecastYear3: netProfitMonthly > 0 ? calculateInvestorYearlyForecast(24, i) : 0,
  forecastTotal: 0
}));

investorYearlyDividends.forEach((divs) => {
  divs.forecastTotal = divs.forecastYear1 + divs.forecastYear2 + divs.forecastYear3;
});

const expenses = {
'–°/–°': revenue * (state.soc / 100),
'–§–û–¢ –≤—Ä–∞—á–µ–π': revenue * (state.fotDoctors / 100),
'–§–û–¢ –ø–µ—Ä—Å–æ–Ω–∞–ª': revenue * (state.fotStaff / 100),
'–ó–¢–õ': revenue * (state.ztl / 100),
'–ö–ª–∏–Ω–∏–∫–∞': revenue * (state.clinic / 100),
'–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥': revenue * (state.marketing / 100),
'–ê—Ä–µ–Ω–¥–∞': state.rent,
'–ö—Ä–µ–¥–∏—Ç': creditPayment,
'–î–∏–≤–∏–¥–µ–Ω–¥—ã': dividendPoolMonthly
};

let paybackMonths = '-', roiAnnual = '-', npv = 0;
if (totalInvestment > 0 && netProfitMonthly > 0) {
const rampUpMonths = 6;
paybackMonths = Math.round(totalInvestment / netProfitMonthly) + rampUpMonths;
roiAnnual = (netProfitAnnual / totalInvestment) * 100;

npv = -totalInvestment;
for (let i = 0; i < 60; i++) {
let monthlyProfit = netProfitMonthly * getSeasonality(i);
if (i < 6) monthlyProfit *= (i / 6 + 0.1);
monthlyProfit *= Math.pow(1.02, i/12);
npv += monthlyProfit / Math.pow(1 + state.discountRate/100, (i+1)/12);
}
}

return {
revenue, revenueAnnual, profit, profitAnnual, netProfitMonthly, netProfitAnnual,
opexMonthly, creditPayment, ebitda, rcpMargin, paybackMonths, roiAnnual, npv,
totalInvestment, expenses, dividendPoolMonthly,
investorYearlyDividends
};
}

function calculateInvestorYearlyForecast(startMonth, investorIndex) {
if (state.investors.length === 0 || state.netProfitMonthly <= 0) return 0;
const totalInvestorShare = state.investors.reduce((sum, inv) => sum + inv.share, 0);
if (totalInvestorShare <= 0) return 0;

let yearlyDividends = 0;
for (let i = 0; i < 12; i++) {
  let monthIndex = (startMonth + i) % 12;
  let monthlyProfit = state.netProfitMonthly * getSeasonality(monthIndex);
  if (startMonth + i < 6) monthlyProfit *= ((startMonth + i) / 6 + 0.1);
  monthlyProfit *= Math.pow(1.02, (startMonth + i)/12);
  const monthlyDividendPool = monthlyProfit * (state.dividendRate / 100);
  yearlyDividends += monthlyDividendPool * (state.investors[investorIndex].share / totalInvestorShare);
}
return yearlyDividends;
}

function formatMoney(num) {
if (isNaN(num) || num === 0) return '0 ‚ÇΩ';
return new Intl.NumberFormat('ru-RU', {
notation: 'compact',
compactDisplay: 'short'
}).format(Math.round(num));
}

function updateAll() {
currentMetrics = calculateMetrics();
updateHeaderKPI(currentMetrics);
updateInvestmentDisplay(currentMetrics);
updateCreditDisplay(currentMetrics);
updateInvestorsDisplay(currentMetrics);
updateCharts(currentMetrics);
}

function updateHeaderKPI(metrics) {
document.getElementById('headerKpis').innerHTML = `
<div class="kpi-item">
<div class="kpi-value">${formatMoney(metrics.revenue)}</div>
<div class="kpi-label">–í—ã—Ä—É—á–∫–∞/–º–µ—Å</div>
</div>
<div class="kpi-item">
<div class="kpi-value">${formatMoney(metrics.revenueAnnual)}</div>
<div class="kpi-label">–í—ã—Ä—É—á–∫–∞/–≥–æ–¥</div>
</div>
<div class="kpi-item">
<div class="kpi-value" style="color: ${metrics.netProfitMonthly > 0 ? 'var(--accent)' : 'var(--danger)'}">
${formatMoney(metrics.netProfitMonthly)}
</div>
<div class="kpi-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å/–º–µ—Å</div>
</div>
<div class="kpi-item">
<div class="kpi-value">${formatMoney(metrics.netProfitAnnual)}</div>
<div class="kpi-label">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å/–≥–æ–¥</div>
</div>
<div class="kpi-item">
<div class="kpi-value">${formatMoney(metrics.opexMonthly + metrics.creditPayment + metrics.dividendPoolMonthly)}</div>
<div class="kpi-label">–†–∞—Å—Ö–æ–¥—ã/–º–µ—Å</div>
</div>
<div class="kpi-item">
<div class="kpi-value">${metrics.rcpMargin.toFixed(1)}%</div>
<div class="kpi-label">R –ø–æ –ß–ü</div>
</div>
<div class="kpi-item">
<div class="kpi-value">${typeof metrics.paybackMonths === 'number' ? metrics.paybackMonths + ' –º–µ—Å' : '-'}</div>
<div class="kpi-label">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å</div>
</div>
<div class="kpi-item">
<div class="kpi-value">${typeof metrics.roiAnnual === 'number' ? metrics.roiAnnual.toFixed(1) + '%' : '-'}</div>
<div class="kpi-label">ROI –≥–æ–¥–æ–≤—ã—Ö</div>
</div>
`;
}

function updateInvestmentDisplay(metrics) {
document.getElementById('totalInvest').textContent = formatMoney(metrics.totalInvestment);

document.getElementById('paybackDisplay').textContent =
typeof metrics.paybackMonths === 'number' ? metrics.paybackMonths + ' –º–µ—Å' : '-';
document.getElementById('roiDisplay').textContent =
typeof metrics.roiAnnual === 'number' ? metrics.roiAnnual.toFixed(1) + '%' : '-';
document.getElementById('npvDisplay').textContent =
metrics.npv > 0 ? '+' + formatMoney(metrics.npv) : formatMoney(metrics.npv);
}

function updateCreditDisplay(metrics) {
const creditDisplay = document.getElementById('creditPaymentDisplay');
if (creditDisplay) {
if (metrics.creditPayment === 0) {
creditDisplay.textContent = '–ü–ª–∞—Ç–µ–∂: 0 ‚ÇΩ/–º–µ—Å (–ø–æ–≥–∞—à–µ–Ω)';
creditDisplay.style.color = 'var(--accent)';
} else {
creditDisplay.textContent = `–ü–ª–∞—Ç–µ–∂: ${formatMoney(metrics.creditPayment)}/–º–µ—Å`;
creditDisplay.style.color = 'var(--danger)';
}
}
}

function updateInvestorsDisplay(metrics) {
const investorsTable = document.getElementById('investorsTable');

if (state.investorCount > 0 && state.investors.length > 0) {
investorsTable.innerHTML = state.investors.slice(0, state.investorCount).map((inv, i) => {
  const divs = metrics.investorYearlyDividends[i] || {forecastYear1: 0, forecastYear2: 0, forecastYear3: 0, forecastTotal: 0};
  return `
    <tr>
      <td>
        <input type="text" class="investor-name-input" value="${inv.name}" 
          onchange="updateInvestorName(${i}, this.value)" 
          onclick="event.stopPropagation()">
      </td>
      <td>
        <input type="number" class="investor-share-input" value="${inv.share.toFixed(1)}" min="0" max="100"
          onchange="updateInvestorShare(${i}, this.value)"
          onclick="event.stopPropagation()">
      </td>
      <td><span class="investor-value">${formatMoney(divs.forecastYear1)}</span></td>
      <td><span class="investor-value">${formatMoney(divs.forecastYear2)}</span></td>
      <td><span class="investor-value">${formatMoney(divs.forecastYear3)}</span></td>
      <td><span class="investor-value">${formatMoney(divs.forecastTotal)}</span></td>
    </tr>
  `;
}).join('');
} else {
investorsTable.innerHTML = '<tr><td colspan="6" class="investor-empty">–î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ —Å –ø–æ–º–æ—â—å—é –ø–æ–ª–∑—É–Ω–∫–∞ –≤—ã—à–µ</td></tr>';
}
}

function updateInvestorName(index, value) {
state.investors[index].name = value;
updateAll();
}

function updateInvestorShare(index, value) {
const newShare = Math.max(0, Math.min(100, +value));
state.investors[index].share = newShare;

// –ï—Å–ª–∏ –≤–≤–æ–¥–∏–º —Ä—É–∫–∞–º–∏, –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–æ–ª–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
const otherInvestors = state.investors.filter((_, i) => i !== index);
if (otherInvestors.length > 0) {
  const remainingShare = 100 - newShare;
  const otherTotalOld = otherInvestors.reduce((sum, inv) => sum + inv.share, 0);
  
  if (otherTotalOld > 0) {
    otherInvestors.forEach(inv => {
      inv.share = (inv.share / otherTotalOld) * remainingShare;
    });
  } else {
    // –ï—Å–ª–∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±—ã–ª–∏ 0, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≤–Ω—É
    const equalShare = remainingShare / otherInvestors.length;
    otherInvestors.forEach(inv => {
      inv.share = equalShare;
    });
  }
}

updateAll();
}

function initCharts() {
const cashCtx = document.getElementById('cashFlowChart').getContext('2d');
cashFlowChart = new Chart(cashCtx, {
type: 'line',
data: { labels: [], datasets: [
{
label: 'Cash Flow, ‚ÇΩ',
data: [],
borderColor: '#00d4aa',
backgroundColor: 'rgba(0,212,170,0.1)',
fill: true,
tension: 0.3
},
{
label: '–ö—Ä–µ–¥–∏—Ç',
data: [],
borderColor: '#ef4444',
backgroundColor: 'rgba(239,68,68,0.2)',
borderDash: [5, 5],
tension: 0.3
}
]},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: { beginAtZero: true, ticks: { callback: v => formatMoney(v) }},
x: { ticks: { maxRotation: 45 }}
}
}
});

const revenueCtx = document.getElementById('revenueVsProfitChart').getContext('2d');
revenueVsProfitChart = new Chart(revenueCtx, {
type: 'line',
data: { 
labels: [], 
datasets: [
{
label: '–¢–æ—á–∫–∞ –ê (–±–∞–∑–æ–≤–∞—è)',
data: [],
borderColor: '#36A2EB',
backgroundColor: 'transparent',
borderWidth: 3,
tension: 0.3,
fill: false
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
interaction: { mode: 'index', intersect: false },
scales: {
y: { beginAtZero: true, ticks: { callback: v => formatMoney(v) }},
x: { ticks: { maxRotation: 45 }}
},
plugins: {
legend: { display: true, position: 'top' },
tooltip: { 
  callbacks: {
    label: function(context) {
      return context.dataset.label + ': ' + formatMoney(context.parsed.y);
    }
  }
}
}
}
});

const expCtx = document.getElementById('expensesChart').getContext('2d');
expensesChart = new Chart(expCtx, {
type: 'doughnut',
data: { labels: [], datasets: [{ data: [], backgroundColor: [
'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
'#9966FF', '#FF9F40', '#C9CBCF', '#ef4444', '#10b981'
] }]},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: { legend: { position: 'bottom' }}
}
});

const seasCtx = document.getElementById('seasonalityChart').getContext('2d');
seasonalityChart = new Chart(seasCtx, {
type: 'bar',
data: {
labels: SEASONALITY.labels,
datasets: [{
label: '–ö–æ—ç—Ñ. —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏',
data: SEASONALITY.factors,
backgroundColor: ctx => ctx.parsed.y < 1 ? 'rgba(255, 99, 132, 0.8)' : 'rgba(75, 192, 192, 0.8)',
borderColor: ctx => ctx.parsed.y < 1 ? 'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)',
borderWidth: 2
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
indexAxis: 'x',
scales: {
y: { min: 0.65, max: 1.15, ticks: { callback: v => v.toFixed(2) }},
x: { ticks: { maxRotation: 0 }}
},
plugins: { legend: { display: false }}
}
});
}

function getSeasonality(monthIndex) {
return SEASONALITY.factors[monthIndex % 12];
}

function updateCharts(metrics) {
const months = Array.from({length: 36}, (_, i) => `–ú${i+1}`);
const cashflows = months.map((_, i) => {
let cf = metrics.netProfitMonthly * getSeasonality(i);
if (i < 6) cf *= (i / 6 + 0.1);
cf *= Math.pow(1.02, i/12);
return cf;
});
const creditFlows = months.map(() =>
(state.payoffDebt && state.capex >= CREDIT.threshold) ? 0 : -CREDIT.monthlyPayment
);

cashFlowChart.data.labels = months;
cashFlowChart.data.datasets[0].data = cashflows;
cashFlowChart.data.datasets[1].data = creditFlows;
cashFlowChart.update();

// –¢–æ—á–∫–∞ –ê (–µ—Å–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞)
const pointAProfits = pointA ? months.map((_, i) => {
const pointAMetrics = calculateMetricsFromState(pointA);
let prf = pointAMetrics.netProfitMonthly * getSeasonality(i);
if (i < 6) prf *= (i / 6 + 0.1);
prf *= Math.pow(1.02, i/12);
return prf;
}) : Array(36).fill(null);

// –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
const scenarioProfits = scenarios.map(scenario => 
months.map((_, i) => {
const scenarioMetrics = calculateMetricsFromState(scenario.state);
let prf = scenarioMetrics.netProfitMonthly * getSeasonality(i);
if (i < 6) prf *= (i / 6 + 0.1);
prf *= Math.pow(1.02, i/12);
return prf;
})
);

// –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç–∞—Å–µ—Ç—ã –≥—Ä–∞—Ñ–∏–∫–∞
const colors = [
'#36A2EB', // –¢–æ—á–∫–∞ –ê - –≥–æ–ª—É–±–∞—è
'#FF9F40', // –æ—Ä–∞–Ω–∂–µ–≤–∞—è
'#FF6384', // —Ä–æ–∑–æ–≤–∞—è
'#FFCE56', // –∂—ë–ª—Ç–∞—è
'#4BC0C0', // –±–∏—Ä—é–∑–∞
'#9966FF', // —Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è
'#C9CBCF', // —Å–µ—Ä–∞—è
'#10b981', // –∑–µ–ª—ë–Ω–∞—è
'#ef4444'  // –∫—Ä–∞—Å–Ω–∞—è
];

// –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ - –¢–æ—á–∫–∞ –ê)
while (revenueVsProfitChart.data.datasets.length > 1) {
  revenueVsProfitChart.data.datasets.pop();
}

// –î–æ–±–∞–≤–ª—è–µ–º –¢–æ—á–∫—É –ê
revenueVsProfitChart.data.datasets[0].data = pointAProfits;

// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
scenarioProfits.forEach((profits, idx) => {
  revenueVsProfitChart.data.datasets.push({
    label: scenarios[idx].name,
    data: profits,
    borderColor: colors[(idx + 1) % colors.length],
    backgroundColor: 'transparent',
    borderWidth: 2,
    borderDash: [5, 5],
    tension: 0.3,
    fill: false
  });
});

revenueVsProfitChart.data.labels = months;
revenueVsProfitChart.update();

const expenseLabels = Object.keys(metrics.expenses).filter((_, i) => metrics.expenses[Object.keys(metrics.expenses)[i]] > 0);
const expenseData = Object.values(metrics.expenses).filter(v => v > 0);
expensesChart.data.labels = expenseLabels;
expensesChart.data.datasets[0].data = expenseData;
expensesChart.update();
}

// –°—Ü–µ–Ω–∞—Ä–∏–∏
function fixPointA() {
pointA = JSON.parse(JSON.stringify(state));
const now = new Date();
document.getElementById('pointADisplay').style.display = 'block';
document.getElementById('pointATime').textContent = now.toLocaleString('ru-RU');
showNotification('–¢–æ—á–∫–∞ –ê –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏.');
}

async function saveScenario() {
const name = document.getElementById('scenarioName').value.trim();
if (!name) {
  showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è', 'error');
  return;
}

scenarios.push({
  name: name,
  timestamp: new Date().toISOString(),
  state: JSON.parse(JSON.stringify(state))
});

saveScenariosToStorage();
document.getElementById('scenarioName').value = '';
updateScenariosTable();
showNotification(`–°—Ü–µ–Ω–∞—Ä–∏–π "${name}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`);
}

function updateScenariosTable() {
const tbody = document.getElementById('scenariosTableBody');

if (scenarios.length === 0) {
  tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 24px;">–°—Ü–µ–Ω–∞—Ä–∏–µ–≤ –µ—â–µ –Ω–µ—Ç. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π!</td></tr>';
  return;
}

tbody.innerHTML = scenarios.map((scenario, idx) => {
  const metrics = calculateMetricsFromState(scenario.state);
  const timestamp = new Date(scenario.timestamp).toLocaleString('ru-RU');
  
  return `
    <tr>
      <td>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span>${scenario.name}</span>
        </div>
      </td>
      <td>${formatMoney(metrics.revenue)}</td>
      <td>${formatMoney(metrics.netProfitMonthly)}</td>
      <td>${typeof metrics.roiAnnual === 'number' ? metrics.roiAnnual.toFixed(1) + '%' : '-'}</td>
      <td style="font-size: 0.85rem; color: var(--text-secondary);">${timestamp}</td>
      <td>
        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="loadScenario(${idx})">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="compareScenario(${idx})">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteScenario(${idx})">–£–¥–∞–ª–∏—Ç—å</button>
      </td>
    </tr>
  `;
}).join('');
}

function loadScenario(index) {
const scenario = scenarios[index];
Object.assign(state, JSON.parse(JSON.stringify(scenario.state)));

// –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∏–Ω–ø—É—Ç—ã –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–ª–∞–π–¥–µ—Ä—ã
const inputs = [
'workDays','chairs','hours','load','normoHour',
'soc','fotDoctors','fotStaff','ztl','clinic','rent','marketing','tax',
'capex','discountRate','investorCount','dividendRate'
];

inputs.forEach(id => {
const sliderEl = document.getElementById(id);
const inputEl = document.getElementById(id + 'Input');

if (sliderEl) {
  sliderEl.value = state[id];
  if (inputEl) inputEl.value = state[id];
}
});

const checkbox = document.getElementById('payoffDebt');
if (checkbox) checkbox.checked = state.payoffDebt;

// –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
state.investors = JSON.parse(JSON.stringify(scenario.state.investors || []));

updateAll();
showNotification(`–°—Ü–µ–Ω–∞—Ä–∏–π "${scenario.name}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
}

function compareScenario(index) {
const scenario = scenarios[index];
const scenarioMetrics = calculateMetricsFromState(scenario.state);
const currentMetrics = calculateMetrics();
const baseMetrics = pointA ? calculateMetricsFromState(pointA) : null;

const formatValue = (val, format) => {
  if (typeof val !== 'number') return '-';
  if (format === 'money') return formatMoney(val);
  if (format === 'percent') return val.toFixed(1) + '%';
  if (format === 'months') return Math.round(val) + ' –º–µ—Å';
  return val;
};

const formatDiff = (val1, val2, format) => {
  if (typeof val1 !== 'number' || typeof val2 !== 'number') return '';
  const diff = val1 - val2;
  if (Math.abs(diff) < 0.01 && format !== 'money') return '0';
  if (format === 'money') return (diff > 0 ? '+' : '') + formatMoney(diff);
  if (format === 'percent') return (diff > 0 ? '+' : '') + diff.toFixed(1) + '%';
  if (format === 'months') return (diff > 0 ? '+' : '') + Math.round(diff) + ' –º–µ—Å';
  return (diff > 0 ? '+' : '') + diff.toFixed(1);
};

const getComparisonClass = (val1, val2) => {
  if (typeof val1 !== 'number' || typeof val2 !== 'number') return '';
  const diff = val1 - val2;
  if (diff > 0) return 'comparison-better';
  if (diff < 0) return 'comparison-worse';
  return '';
};

let html = `
<h3 style="margin: 20px 0 15px; color: var(--accent);">${scenario.name} vs –¢–µ–∫—É—â–∏–π</h3>
<table class="comparison-table">
<thead>
<tr>
<th>–ú–µ—Ç—Ä–∏–∫–∞</th>
<th>–°—Ü–µ–Ω–∞—Ä–∏–π: ${scenario.name}</th>
<th>–¢–µ–∫—É—â–∏–π</th>
<th>–†–∞–∑–Ω–∏—Ü–∞</th>
</tr>
</thead>
<tbody>
`;

const metrics = [
  { label: '–í—ã—Ä—É—á–∫–∞/–º–µ—Å', key: 'revenue', format: 'money' },
  { label: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å/–º–µ—Å', key: 'netProfitMonthly', format: 'money' },
  { label: '–í—ã—Ä—É—á–∫–∞/–≥–æ–¥', key: 'revenueAnnual', format: 'money' },
  { label: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å/–≥–æ–¥', key: 'netProfitAnnual', format: 'money' },
  { label: 'ROI –≥–æ–¥–æ–≤—ã—Ö', key: 'roiAnnual', format: 'percent' },
  { label: 'NPV (5 –ª–µ—Ç)', key: 'npv', format: 'money' },
  { label: '–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å', key: 'paybackMonths', format: 'months' }
];

metrics.forEach(m => {
  const scenarioVal = scenarioMetrics[m.key];
  const currentVal = currentMetrics[m.key];
  const diff = formatDiff(scenarioVal, currentVal, m.format);
  const className = getComparisonClass(scenarioVal, currentVal);

  html += `
    <tr>
      <td><strong>${m.label}</strong></td>
      <td>${formatValue(scenarioVal, m.format)}</td>
      <td>${formatValue(currentVal, m.format)}</td>
      <td class="${className}">${diff}</td>
    </tr>
  `;
});

html += `</tbody></table>`;

if (baseMetrics) {
html += `
<h3 style="margin: 30px 0 15px; color: var(--accent);">vs –¢–æ—á–∫–∞ –ê (–ë–∞–∑–æ–≤—ã–π)</h3>
<table class="comparison-table">
<thead>
<tr>
<th>–ú–µ—Ç—Ä–∏–∫–∞</th>
<th>–¢–æ—á–∫–∞ –ê</th>
<th>–°—Ü–µ–Ω–∞—Ä–∏–π: ${scenario.name}</th>
<th>–†–∞–∑–Ω–∏—Ü–∞</th>
</tr>
</thead>
<tbody>
`;

  metrics.forEach(m => {
    const baseVal = baseMetrics[m.key];
    const scenarioVal = scenarioMetrics[m.key];
    const diff = formatDiff(scenarioVal, baseVal, m.format);
    const className = getComparisonClass(scenarioVal, baseVal);

    html += `
      <tr>
        <td><strong>${m.label}</strong></td>
        <td>${formatValue(baseVal, m.format)}</td>
        <td>${formatValue(scenarioVal, m.format)}</td>
        <td class="${className}">${diff}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
}

document.getElementById('comparisonContent').innerHTML = html;
document.getElementById('comparisonModal').classList.add('active');
}

function closeComparison() {
document.getElementById('comparisonModal').classList.remove('active');
}

function deleteScenario(index) {
const scenario = scenarios[index];
if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π "${scenario.name}"?`)) return;

scenarios.splice(index, 1);
saveScenariosToStorage();
updateScenariosTable();
showNotification(`–°—Ü–µ–Ω–∞—Ä–∏–π "${scenario.name}" —É–¥–∞–ª–µ–Ω!`);
}

function calculateMetricsFromState(stateData) {
const s = stateData;
const capacity = s.workDays * s.chairs * s.hours;
const utilization = capacity * (s.load / 100);
const revenue = utilization * s.normoHour;
const revenueAnnual = revenue * 12;

const totalVarCosts = revenue * ((
s.soc + s.fotDoctors + s.fotStaff +
s.ztl + s.clinic + s.marketing
) / 100);

const opexMonthly = totalVarCosts + s.rent;
const ebitda = revenue - opexMonthly;
const profit = ebitda * (1 - s.tax / 100);
const profitAnnual = profit * 12;

const creditPayment = (s.payoffDebt && s.capex >= CREDIT.threshold) ? 0 : CREDIT.monthlyPayment;
const netProfitMonthly = profit - creditPayment;
const netProfitAnnual = netProfitMonthly * 12;
const rcpMargin = ebitda / revenue * 100 || 0;

const totalInvestment = s.capex;

let paybackMonths = '-', roiAnnual = '-', npv = 0;
if (totalInvestment > 0 && netProfitMonthly > 0) {
const rampUpMonths = 6;
paybackMonths = Math.round(totalInvestment / netProfitMonthly) + rampUpMonths;
roiAnnual = (netProfitAnnual / totalInvestment) * 100;

npv = -totalInvestment;
for (let i = 0; i < 60; i++) {
let monthlyProfit = netProfitMonthly * getSeasonality(i);
if (i < 6) monthlyProfit *= (i / 6 + 0.1);
monthlyProfit *= Math.pow(1.02, i/12);
npv += monthlyProfit / Math.pow(1 + s.discountRate/100, (i+1)/12);
}
}

return {
revenue, revenueAnnual, profit, profitAnnual, netProfitMonthly, netProfitAnnual,
opexMonthly, creditPayment, ebitda, rcpMargin, paybackMonths, roiAnnual, npv,
totalInvestment
};
}

function showNotification(message, type = 'success') {
const notification = document.createElement('div');
notification.style.cssText = `
position: fixed;
top: 100px;
right: 20px;
background: ${type === 'error' ? 'var(--danger)' : 'var(--accent)'};
color: ${type === 'error' ? '#fff' : '#000'};
padding: 16px 24px;
border-radius: 8px;
font-weight: 600;
z-index: 3000;
animation: slideIn 0.3s ease-out;
`;
notification.textContent = message;
document.body.appendChild(notification);

setTimeout(() => notification.remove(), 3000);
}

function toggleTheme() {
const isDark = document.body.getAttribute('data-theme') === 'light';
document.body.setAttribute('data-theme', isDark ? '' : 'light');
this.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
}
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d07b6b0415bf975',t:'MTc3MTUyNDU0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>


